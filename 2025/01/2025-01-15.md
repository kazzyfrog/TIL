---
date created: 2025-01-16, 03:55
date modified: 2025-01-16, 04:37
---

æ˜¨æ—¥ã«å¼•ãç¶šãã€useAPI ã‚„ã€suspense å‘¨ã‚Šã‚’èª¿ã¹ãŸï¼

title: "React ã® Suspense ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ "

## ã¯ã˜ã‚ã«

React ã§ã®éåŒæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ã«ãŠã„ã¦ã€Suspense ã¯é‡è¦ãªæ©Ÿèƒ½ã® 1 ã¤ã§ã™ã€‚
ã—ã‹ã—ã€ãã®ä»•çµ„ã¿ã‚„ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ã€ãªã‹ãªã‹ç†è§£ãŒé›£ã—ã„éƒ¨åˆ†ã‚‚ã‚ã‚Šã¾ã™ã€‚

ä»Šå›ã¯ã€**Suspense ã®ä»•çµ„ã¿ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã®å®Ÿè£…ã«ã¤ã„ã¦èª¿æŸ»ã—ãŸ**ã®ã§ã€åŸºç¤çš„ãªå†…å®¹ã‚’ã¾ã¨ã‚ã¾ã—ãŸï¼
å®Ÿè£…ã®å‚è€ƒã«ãªã‚Œã°ã€å¬‰ã—ã„ã§ã™ ğŸ™Œ

## Suspense ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã®åŸºæœ¬

### ãªãœ Suspense ãŒå¿…è¦ï¼Ÿ

React ã§ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç›´æ¥ `async` ã¨ã—ã¦æ‰±ã†ã“ã¨ãŒã§ãã¾ã›ã‚“ï¼š

```jsx
// âŒ ã“ã‚Œã¯ã§ããªã„
async function Component() {
  const data = await fetchData();
  return <div>{data}</div>;
}
```

ãã“ã§ã€Suspense ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€éåŒæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’å®£è¨€çš„ã«æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ï¼š

```jsx
// âœ… Suspenseã‚’ä½¿ç”¨
<Suspense fallback={<Loading />}>
  <Component />
</Suspense>
```

### ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä»•çµ„ã¿

Suspense ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è¡Œã†å ´åˆã€ä»¥ä¸‹ã® 3 ã¤ã®çŠ¶æ…‹ã‚’æ‰±ã„ã¾ã™ï¼š

1. pendingï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ï¼‰
2. successï¼ˆæˆåŠŸï¼‰
3. errorï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰

ã“ã‚Œã‚‰ã®çŠ¶æ…‹ã«å¿œã˜ã¦ã€é©åˆ‡ãª UI ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å®Ÿè£…æ–¹æ³•ã®æ¯”è¼ƒ

### 1. wrapPromise ã‚’ä½¿ã£ãŸç†è§£ï¼ˆåŸºæœ¬æ¦‚å¿µã®ç†è§£ï¼‰

ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®åŸºæœ¬çš„ãªå®Ÿè£…ä¾‹ã§ã™ï¼š

```typescript
function wrapPromise(promise) {
  let status = "pending";
  let result;
  const suspender = promise.then(
    (response) => {
      status = "success";
      result = response;
    },
    (error) => {
      status = "error";
      result = error;
    }
  );

  return {
    read() {
      if (status === "pending") {
        throw suspender; // Suspenseã«ã‚­ãƒ£ãƒƒãƒã•ã‚Œã‚‹
      } else if (status === "error") {
        throw result;
      } else if (status === "success") {
        return result;
      }
    },
  };
}
```

ä½¿ç”¨ä¾‹ï¼š

```jsx
const dataResource = wrapPromise(fetchData());

function Component() {
  const data = dataResource.read();
  return <div>{data}</div>;
}
```

### 2. use ãƒ•ãƒƒã‚¯ï¼ˆReact 18ï¼‰

React 18 ã§ã¯ã€`use` ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã‚ˆã‚Šç°¡æ½”ã«å®Ÿè£…ã§ãã¾ã™ï¼š

```jsx
function Component() {
  const data = use(fetchData());
  return <div>{data}</div>;
}
```

ãŸã ã—ã€ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€Promise ã®ç”Ÿæˆã‚’é©åˆ‡ã«ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

```jsx
function Component({ id }) {
  // âœ… ãƒ¡ãƒ¢åŒ–ã—ã¦Promiseã‚’ç®¡ç†
  const dataPromise = useMemo(() => fetchData(id), [id]);
  const data = use(dataPromise);
  return <div>{data}</div>;
}
```

### 3. Server Componentsï¼ˆNext.jsï¼‰

Next.js ã® Server Components ã§ã¯ã€ç›´æ¥ `async/await` ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

```jsx
// Server Component
async function ServerComponent() {
  const data = await fetchData();
  return <div>{data}</div>;
}
```

## å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½¿ã„åˆ†ã‘

å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ã„åˆ†ã‘ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ï¼š

1. Server Componentsï¼ˆRSCï¼‰ãŒä½¿ãˆã‚‹å ´åˆï¼š

   - ç›´æ¥ `async/await` ã‚’ä½¿ç”¨
   - æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„

2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å ´åˆï¼š
   - `use` ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨
   - Promise ã®ç”Ÿæˆã‚’é©åˆ‡ã«ç®¡ç†

## ãƒã‚¤ãƒ³ãƒˆ

- React ã§ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ async ã¨ã—ã¦æ‰±ã†ã“ã¨ãŒã§ããªã„ã®ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’ç›´æ¥ await ã™ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã€æ“¬ä¼¼çš„ãªæŒ™å‹•ã‚’å†ç¾ã™ã‚‹ãŸã‚ã« `wrapPromise` é–¢æ•°ã‚’è‡ªä½œ
- ã“ã®é–¢æ•°ã¯ã€Promise ã‚’ãƒ©ãƒƒãƒ—ã—ã¦ã€Suspense å¯¾å¿œã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã„ã‚‹
- pending ã®çŠ¶æ…‹ã§ promise ã‚’ã‚¹ãƒ­ãƒ¼ã§ãã‚‹ã®ã§ã€await ã¨åŒã˜å½¹å‰²ã‚’æœãŸã—ã€suspense ãŒã‚­ãƒ£ãƒƒãƒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
- ã“ã‚Œã¯ã€Next.js ã§ã¯ã€RSC ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ async ã¨ã—ã¦æ‰±ã†ã“ã¨ã§ç°¡ç•¥åŒ–ã§ãã‚‹
- React 19 ã§å®‰å®šã¨ãªã£ãŸ `use` ãƒ•ãƒƒã‚¯ã‚‚ã¾ãŸã€`wrapPromise` é–¢æ•°ã¨åŒæ§˜ã®ä»•çµ„ã¿ã‚’è¡Œã£ã¦ãŠã‚Šã€ã‚ˆã‚ŠåŠ¹ç‡çš„ã§ã‚ã‚‹

* ãªãŠã€promise ãŒå†ç”Ÿæˆã•ã‚Œç¶šã‘ã‚‹ã“ã¨ã§ã€ç„¡é™ãƒ«ãƒ¼ãƒ—ãŒç™ºç”Ÿã™ã‚‹ã®ã§ã€æ³¨æ„

RSC ã§ã¯ã€ç›´æ¥ async ãŒä½¿ãˆã‚‹ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ä½¿ãˆãªã„ã®ã§ã€ä»Šå›ã®ã‚ˆã†ã« wrapPromise ã§å‡¦ç†ã‚’ç†è§£ã—ã€å®Ÿéš›ã¯ use ãªã©ã‚’ä½¿ã†ï¼
ãªãŠã€ã‚ˆã‚Šç¾å®Ÿçš„ã«ã¯ã€TanStack Query ã‚„ SWR ã§ååˆ†ï¼

å‚è€ƒ
https://azukiazusa.dev/blog/promise-context-value-react-hook/
https://zenn.dev/uhyo/books/react-concurrent-handson/viewer/data-fetching-2
https://zenn.dev/mzd/articles/0b2e54eac31ceb
